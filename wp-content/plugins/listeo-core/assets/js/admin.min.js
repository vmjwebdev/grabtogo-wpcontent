//!function(t){"use strict";t(function(){new google.maps.Geocoder;t("#_address").geocomplete().bind("geocode:result",function(e,i){var o=i.geometry.location,s=o.lat(),n=o.lng();t("#_geolocation_lat").val(s),t("#_geolocation_long").val(n)}),t(document.body).on("change","#tb_select",function(){if(t(this).val()){var e=t(this).parent().parent();console.log(e)}}),t("#tb_save").on("click",function(){console.log(t(this).text()),tb_remove()})})}(jQuery),function(t,e,i,o){function s(e,i){this.options=t.extend(!0,{},n,i),i&&i.types&&(this.options.types=i.types),this.input=e,this.$input=t(e),this._defaults=n,this._name="geocomplete",this.init()}var n={bounds:!0,country:null,map:!1,details:!1,detailsAttribute:"name",detailsScope:null,autoselect:!0,location:!1,mapOptions:{zoom:14,scrollwheel:!1,mapTypeId:"roadmap"},markerOptions:{draggable:!1},maxZoom:16,types:["geocode"],blur:!1,geocodeAfterResult:!1,restoreValueAfterBlur:!1},a="street_address route intersection political country administrative_area_level_1 administrative_area_level_2 administrative_area_level_3 colloquial_area locality sublocality neighborhood premise subpremise postal_code natural_feature airport park point_of_interest post_box street_number floor room lat lng viewport location formatted_address location_type bounds".split(" "),r="id place_id url website vicinity reference name rating international_phone_number icon formatted_phone_number".split(" ");t.extend(s.prototype,{init:function(){this.initMap(),this.initMarker(),this.initGeocoder(),this.initDetails(),this.initLocation()},initMap:function(){this.options.map&&("function"!=typeof this.options.map.setCenter?(this.map=new google.maps.Map(t(this.options.map)[0],this.options.mapOptions),google.maps.event.addListener(this.map,"click",t.proxy(this.mapClicked,this)),google.maps.event.addListener(this.map,"dragend",t.proxy(this.mapDragged,this)),google.maps.event.addListener(this.map,"idle",t.proxy(this.mapIdle,this)),google.maps.event.addListener(this.map,"zoom_changed",t.proxy(this.mapZoomed,this))):this.map=this.options.map)},initMarker:function(){if(this.map){var e=t.extend(this.options.markerOptions,{map:this.map});e.disabled||(this.marker=new google.maps.Marker(e),google.maps.event.addListener(this.marker,"dragend",t.proxy(this.markerDragged,this)))}},initGeocoder:function(){var e={types:this.options.types,bounds:!0===this.options.bounds?null:this.options.bounds,componentRestrictions:this.options.componentRestrictions};this.options.country&&(e.componentRestrictions={country:this.options.country}),this.autocomplete=new google.maps.places.Autocomplete(this.input,e),this.geocoder=new google.maps.Geocoder,this.map&&!0===this.options.bounds&&this.autocomplete.bindTo("bounds",this.map),google.maps.event.addListener(this.autocomplete,"place_changed",t.proxy(this.placeChanged,this)),this.$input.on("keypress."+this._name,function(t){if(13===t.keyCode)return!1}),!0===this.options.geocodeAfterResult&&this.$input.bind("keypress."+this._name,t.proxy(function(){9!=event.keyCode&&!0===this.selected&&(this.selected=!1)},this)),this.$input.bind("geocode."+this._name,t.proxy(function(){this.find()},this)),this.$input.bind("geocode:result."+this._name,t.proxy(function(){this.lastInputVal=this.$input.val()},this)),!0===this.options.blur&&this.$input.on("blur."+this._name,t.proxy(function(){!0===this.options.geocodeAfterResult&&!0===this.selected||(!0===this.options.restoreValueAfterBlur&&!0===this.selected?setTimeout(t.proxy(this.restoreLastValue,this),0):this.find())},this))},initDetails:function(){function e(t){s[t]=i.find("["+o+"="+t+"]")}if(this.options.details){if(this.options.detailsScope)i=t(this.input).parents(this.options.detailsScope).find(this.options.details);else var i=t(this.options.details);var o=this.options.detailsAttribute,s={};t.each(a,function(t,i){e(i),e(i+"_short")}),t.each(r,function(t,i){e(i)}),this.$details=i,this.details=s}},initLocation:function(){var t,e=this.options.location;e&&("string"!=typeof e?(e instanceof Array&&(t=new google.maps.LatLng(e[0],e[1])),e instanceof google.maps.LatLng&&(t=e),t&&(this.map&&this.map.setCenter(t),this.marker&&this.marker.setPosition(t))):this.find(e))},destroy:function(){this.map&&(google.maps.event.clearInstanceListeners(this.map),google.maps.event.clearInstanceListeners(this.marker)),this.autocomplete.unbindAll(),google.maps.event.clearInstanceListeners(this.autocomplete),google.maps.event.clearInstanceListeners(this.input),this.$input.removeData(),this.$input.off(this._name),this.$input.unbind("."+this._name)},find:function(t){this.geocode({address:t||this.$input.val()})},geocode:function(e){e.address&&(this.options.bounds&&!e.bounds&&(!0===this.options.bounds?e.bounds=this.map&&this.map.getBounds():e.bounds=this.options.bounds),this.options.country&&(e.region=this.options.country),this.geocoder.geocode(e,t.proxy(this.handleGeocode,this)))},selectFirstResult:function(){var e="";t(".pac-item-selected")[0]&&(e="-selected");var i=t(".pac-container:visible .pac-item"+e+":first span:nth-child(2)").text(),o=t(".pac-container:visible .pac-item"+e+":first span:nth-child(3)").text(),s=i;return o&&(s+=" - "+o),this.$input.val(s),s},restoreLastValue:function(){this.lastInputVal&&this.$input.val(this.lastInputVal)},handleGeocode:function(t,e){if(e===google.maps.GeocoderStatus.OK){var i=t[0];this.$input.val(i.formatted_address),this.update(i),t.length>1&&this.trigger("geocode:multiple",t)}else this.trigger("geocode:error",e)},trigger:function(t,e){this.$input.trigger(t,[e])},center:function(t){t.viewport?(this.map.fitBounds(t.viewport),this.map.getZoom()>this.options.maxZoom&&this.map.setZoom(this.options.maxZoom)):(this.map.setZoom(this.options.maxZoom),this.map.setCenter(t.location)),this.marker&&(this.marker.setPosition(t.location),this.marker.setAnimation(this.options.markerOptions.animation))},update:function(t){this.map&&this.center(t.geometry),this.$details&&this.fillDetails(t),this.trigger("geocode:result",t)},fillDetails:function(e){var i={},o=e.geometry,s=o.viewport,n=o.bounds;t.each(e.address_components,function(e,o){o.types[0];t.each(o.types,function(t,e){i[e]=o.long_name,i[e+"_short"]=o.short_name})}),t.each(r,function(t,o){i[o]=e[o]}),t.extend(i,{formatted_address:e.formatted_address,location_type:o.location_type||"PLACES",viewport:s,bounds:n,location:o.location,lat:o.location.lat(),lng:o.location.lng()}),t.each(this.details,t.proxy(function(t,e){var o=i[t];this.setDetail(e,o)},this)),this.data=i},setDetail:function(t,e){void 0===e?e="":"function"==typeof e.toUrlValue&&(e=e.toUrlValue()),t.is(":input")?t.val(e):t.text(e)},markerDragged:function(t){this.trigger("geocode:dragged",t.latLng)},mapClicked:function(t){this.trigger("geocode:click",t.latLng)},mapDragged:function(t){this.trigger("geocode:mapdragged",this.map.getCenter())},mapIdle:function(t){this.trigger("geocode:idle",this.map.getCenter())},mapZoomed:function(t){this.trigger("geocode:zoom",this.map.getZoom())},resetMarker:function(){this.marker.setPosition(this.data.location),this.setDetail(this.details.lat,this.data.location.lat()),this.setDetail(this.details.lng,this.data.location.lng())},placeChanged:function(){var t=this.autocomplete.getPlace();if(this.selected=!0,t.geometry)this.update(t);else if(this.options.autoselect){var e=this.selectFirstResult();this.find(e)}}}),t.fn.geocomplete=function(e){var i="plugin_geocomplete";if("string"==typeof e){var o=t(this).data(i)||t(this).geocomplete().data(i),n=o[e];return"function"==typeof n?(n.apply(o,Array.prototype.slice.call(arguments,1)),t(this)):(2==arguments.length&&(n=arguments[1]),n)}return this.each(function(){var o=t.data(this,i);o||(o=new s(this,e),t.data(this,i,o))})}}(jQuery,window,document);
(function ( $ ) {
	"use strict";

	$(function () {
   	
	

	$(document).ready(function () {
      // Initialize calendar
      submit_calendar_update_unav_days();

      // Re-run after ajax updates
      $(document).on("ajaxComplete", function () {
        submit_calendar_update_unav_days();
      });
    });

	function submit_calendar_update_unav_days() {
    var days = $(".listeo-calendar-avail").val();
    if (!days) return;

    try {
      var array = days.split("|").filter(function (day) {
        return day.trim() !== "";
      });

      $.each(array, function (key, day) {
        var $day = $("td.listeo-calendar-day[data-date='" + day + "']");
        if ($day.length) {
          $day.addClass("not_active");
        }
      });
    } catch (e) {
      console.error("Error updating calendar days:", e);
    }
  }

// 


$("#booking_admin-listing_id_autocomplete").autocomplete({
  source: function (request, response) {
    $.ajax({
      dataType: "json",
      url: listeo_admin.ajax_url,
      data: {
        term: request.term,
        action: "listingAutocompleteSearch",
        security: listeo_admin.ajax_nonce,
      },
      success: function (data) {
        response(data);
      },
    });
  },
  select: function (event, ui) {
    $("#booking_admin-listing_id").val(ui.item.id);
    console.log(ui.item.id)
  },
  minLength: 3,
});
	/*Form editor in thickbox*/


	$( ".clear-time-picker" ).on( "click", function(e) {
		e.preventDefault();
		$(this).prev().val('');
	});

	$( ".add-time-picker" ).on( "click", function(e) {
		e.preventDefault();
		var parents = $(this).parents('.cmb-row');
		var open_clone = parents.find('.cmb-td input').last().clone();
		var closing_clone = $(this).parents('.opening_hours_column').find('.cmb-row:last-child .cmb-td input').last().clone();
		open_clone.appendTo($(this).parents('.cmb-row').find('.cmb-td'));

		closing_clone.appendTo($(this).parents('.opening_hours_column').find('.cmb-row:last-child .cmb-td'));
		//clone.before($(this));
		
	});

	 $(document.body).on('change', '#tb_select', function () {
        var type = $(this).val();
        if(type) {

            var here = $(this).parent().parent();
            console.log(here);
        	
        }
    });

	$( "#tb_save" ).on( "click", function() {
		console.log( $( this ).text() );
		tb_remove();
	});

		var file_frame;
 
	$('.realteo-additional-user-image').on('click', function( event ){

		event.preventDefault();

		// If the media frame already exists, reopen it.
		if ( file_frame ) {
		  file_frame.open();
		  return;
		}

		// Create the media frame.
		file_frame = wp.media.frames.file_frame = wp.media({
		  title: $( this ).data( 'uploader_title' ),
		  button: {
		    text: $( this ).data( 'uploader_button_text' ),
		  },
		  multiple: false  // Set to true to allow multiple files to be selected
		});

		// When an image is selected, run a callback.
		file_frame.on( 'select', function() {
		  // We set multiple to false so only get one image from the uploader
		  var attachment = file_frame.state().get('selection').first().toJSON();
		  $('#agent-avatar').val(attachment.id);
		  // Do something with attachment.id and/or attachment.url here
		});

		// Finally, open the modal
		file_frame.open();
	});

	$(".listeo-custom-image-upload").on("click", function (event) {
    var currentButton = $(this);
    event.preventDefault();

    // Create a new file frame each time to avoid state issues
    var file_frame = (wp.media.frames.file_frame = wp.media({
      title: $(this).data("uploader_title"),
      button: {
        text: $(this).data("uploader_button_text"),
      },
      multiple: false, // Set to false to allow only one file to be selected
    }));

    // When an image is selected, run a callback
    file_frame.on("select", function () {
      // We set multiple to false so only get one image from the uploader
      var attachment = file_frame.state().get("selection").first().toJSON();

      // Update the input field that comes before the clicked button
      currentButton.prev().val(attachment.id);
    });

    // Finally, open the modal
    file_frame.open();
  });
	
/* Start Document */

// $('.listeo_map_settings').hide();
// $('.listeo_map_settings.map_provider').cha();
$('.listeo_map_settings.map_provider input[type=radio]').on('change', function() {
     switch($(this).val()) {
         case 'osm':
             	$('.listeo_map_settings.maps_api').hide();
             	$('.listeo_map_settings.mapbox_access_token').hide();
             	$('.listeo_map_settings.mapbox_style_url').hide();
             	$('.listeo_map_settings.mapbox_retina').hide();
				$('.listeo_map_settings.bing_maps_key').hide();
				$('.listeo_map_settings.thunderforest_api_key').hide();
				$('.listeo_map_settings.here_app_id').hide();
             	$('.listeo_map_settings.here_app_code').hide();
             break;
         case 'google':
	            $('.listeo_map_settings.maps_api').show();
             	$('.listeo_map_settings.mapbox_access_token').hide();
             	$('.listeo_map_settings.mapbox_style_url').hide();
				$('.listeo_map_settings.bing_maps_key').hide();
				$('.listeo_map_settings.mapbox_retina').hide();
				$('.listeo_map_settings.thunderforest_api_key').hide();
				$('.listeo_map_settings.here_app_id').hide();
             	$('.listeo_map_settings.here_app_code').hide();
             break;
         case 'mapbox':
             $('.listeo_map_settings.mapbox_access_token').show();
             $('.listeo_map_settings.mapbox_retina').show();
             $('.listeo_map_settings.mapbox_style_url').show();
             $('.listeo_map_settings.maps_api').hide();
             	
				$('.listeo_map_settings.bing_maps_key').hide();
				
				$('.listeo_map_settings.thunderforest_api_key').hide();
				$('.listeo_map_settings.here_app_id').hide();
             	$('.listeo_map_settings.here_app_code').hide();
             break;         
        case 'bing':
             	$('.listeo_map_settings.bing_maps_key').show();
             	$('.listeo_map_settings.maps_api').hide();
             	$('.listeo_map_settings.mapbox_retina').hide();
             	$('.listeo_map_settings.mapbox_access_token').hide();
             	$('.listeo_map_settings.mapbox_style_url').hide();
				$('.listeo_map_settings.thunderforest_api_key').hide();
				$('.listeo_map_settings.here_app_id').hide();
             	$('.listeo_map_settings.here_app_code').hide();
             break;       
        case 'thunderforest':
             	$('.listeo_map_settings.thunderforest_api_key').show();
             	$('.listeo_map_settings.maps_api').hide();
             	$('.listeo_map_settings.mapbox_retina').hide();
             	$('.listeo_map_settings.mapbox_access_token').hide();
             	$('.listeo_map_settings.mapbox_style_url').hide();
				$('.listeo_map_settings.bing_maps_key').hide();
				$('.listeo_map_settings.here_app_id').hide();
             	$('.listeo_map_settings.here_app_code').hide();
             break;        
        case 'here':
             	$('.listeo_map_settings.here_app_id').show();
             	$('.listeo_map_settings.here_app_code').show();
             	$('.listeo_map_settings.maps_api').hide();
             	$('.listeo_map_settings.mapbox_retina').hide();
             	$('.listeo_map_settings.mapbox_access_token').hide();
             	$('.listeo_map_settings.mapbox_style_url').hide();
				$('.listeo_map_settings.bing_maps_key').hide();
				$('.listeo_map_settings.thunderforest_api_key').hide();
				
             break;

          
     }
});
$('.listeo_map_settings.map_provider input[type=radio]:checked').trigger('change');

 $('#listeo_core_booking_metabox')
    .on( 'init', function() {
        
    })
    $('#_booking_status').change(function() {
        if(this.checked) {
        	var type = $("#_listing_type").val();
        	if(type == 'service'){
        		$('.cmb2-id--slots-status').show();
			 	$('.cmb2-id--slots').show();
        	}
        	if(type == 'event'){
        		$('.cmb2-id--event-tickets').show();
        	}
        	if(type == 'rental'){
        		$('.cmb2-id--weekday-price').show();
        		$('.cmb2-id--availability').show();
        	}
			$('.cmb2-id--normal-price').show();
			$('.cmb2-id--weekday-price').show();
			$('.cmb2-id--reservation-price').show();
			$('.cmb2-id--expired-after').show();
			$('.cmb2-id--count-per-guest').show();
			$('.cmb2-id--max-guests').show();
    		  
        } else {
			 $('.cmb2-id--slots-status').hide();
			 $('.cmb2-id--slots').hide();
			 $('.cmb2-id--event-tickets').hide();
			 $('.cmb2-id--normal-price').hide();
			 $('.cmb2-id--weekday-price').hide();
			 $('.cmb2-id--reservation-price').hide();
			 $('.cmb2-id--expired-after').hide();
			 $('.cmb2-id--count-per-guest').hide();
			 $('.cmb2-id--max-guests').hide();
			 $('.cmb2-id--availability').hide();
        }
    
    });

    $('#_listing_type').change(function() {
    	if( $('#_booking_status').checked ){
    		var type = $("#_listing_type").val();
    		if(type == 'service'){
        		$('.cmb2-id--slots-status').show();
			 	$('.cmb2-id--slots').show();
			 	$('.cmb2-id--event-tickets').hide();
			 	$('.cmb2-id--weekday-price').hide();
        		$('.cmb2-id--availability').hide();
        	}
        	if(type == 'event'){
        		$('.cmb2-id--slots-status').hide();
			 	$('.cmb2-id--slots').hide();
			 	$('.cmb2-id--event-tickets').show();
			 	$('.cmb2-id--weekday-price').hide();
        		$('.cmb2-id--availability').hide();
        	}
        	if(type == 'rental'){
        		$('.cmb2-id--slots-status').hide();
			 	$('.cmb2-id--slots').hide();
			 	$('.cmb2-id--event-tickets').hide();
			 	$('.cmb2-id--weekday-price').show();
        		$('.cmb2-id--availability').show();
        	}
        	$('.cmb2-id--normal-price').show();
			$('.cmb2-id--weekday-price').show();
			$('.cmb2-id--reservation-price').show();
			$('.cmb2-id--expired-after').show();
			$('.cmb2-id--count-per-guest').show();
			$('.cmb2-id--max-guests').show();
    	}
    	});
    

	// slots

	 // Add validation parts
    $('.day-slots').each(function(){

    	var daySlots = $(this);

		daySlots.find('.add-slot-btn').on('click', function(e) {
			e.preventDefault();

			var slotTime_Start = daySlots.find('.add-slot-inputs input.time-slot-start').val();
			var slotTimePM_AM_Start = daySlots.find('.add-slot-inputs select.time-slot-start').val();

			var slotTime_End = daySlots.find('.add-slot-inputs input.time-slot-end').val();
			var slotTimePM_AM_End = daySlots.find('.add-slot-inputs select.time-slot-end').val();

			// Checks if input values are not blank
			if( slotTime_Start.length > 0 && slotTime_End.length > 0) {

				    // New Time Slot Div
					var newTimeSlot = daySlots
									.find('.single-slot.cloned')
									.clone(true)
									.addClass('slot-animation')
									.removeClass('cloned');

					setTimeout(function(){
						newTimeSlot.removeClass('slot-animation');
					}, 300);

					newTimeSlot.find('.plusminus input').val('1');

					// Plus - Minus Init
	  				newTimeSlot.find('.plusminus').numberPicker();

					// Check if there's am/pm dropdown
				    var $twelve_hr = $('.add-slot-inputs select.twelve-hr');

				    if ( $twelve_hr.length){
				        newTimeSlot.find('.single-slot-time').html(slotTime_Start + ' ' + '<i class="am-pm">'+slotTimePM_AM_Start+'</i>' + ' - '+ slotTime_End + ' ' + '<i class="am-pm">'+slotTimePM_AM_End+'</i>');
				    } else {
				    	newTimeSlot.find('.single-slot-time').html(''+ slotTime_Start + ' - ' + slotTime_End);
				    }

				    // Appending new slot
					newTimeSlot.appendTo(daySlots.find('.slots-container'));

					// Refresh sotrable script
					$(".slots-container").sortable('refresh');
					update_slots();
			} 

			// Validation Error
			else {
				daySlots.find('.add-slot').addClass('add-slot-shake-error');
				setTimeout(function(){
					daySlots.find('.add-slot').removeClass('add-slot-shake-error');
				}, 600);
			}
		});

	    // Removing "no slots" message
		function hideSlotInfo() {
			var slotCount = daySlots.find(".slots-container").children().length;
			if ( slotCount < 1 ) {
				daySlots.find(".no-slots")
						.addClass("no-slots-fadein")
						.removeClass("no-slots-fadeout");
			} 
		}
		hideSlotInfo();


		// Removing Slot
	    daySlots.find('.remove-slot').bind('click', function(e) {
	    	e.preventDefault();
			$(this).closest('.single-slot').animate({height: 0, opacity: 0}, 'fast', function() { 
				$(this).remove();
			});

			// Removing "no slots" message
			setTimeout(function(){
				hideSlotInfo();
				update_slots();
			}, 400);


		});

	    // Showing "no slots" message
		daySlots.find('.add-slot-btn').on('click', function(e) {
			e.preventDefault();
			var slotCount = daySlots.find(".slots-container").children().length;
			if ( slotCount >= 1 ) {
				daySlots.find(".no-slots")
						.removeClass("no-slots-fadein")
						.addClass("no-slots-fadeout");
			} 
		});

    });

    // Sotrable Script
    if( $('.cmb-type-slots').length > 0 ){
    	$( ".slots-container" ).sortable();	
    }
    

	// 24 hour clock type switcher
	if ( $('.availability-slots').attr('data-clock-type') == '24hr' ) {
		$('.availability-slots').addClass('twenty-four-clock');
		$('.availability-slots').find('input[type="time"]').attr({ "max" : "24:00"});
	}

	// Number Picker - TobyJ
	(function ($) {
	  $.fn.numberPicker = function() {
	    var dis = 'disabled';
	    return this.each(function() {
	      var picker = $(this),
	          p = picker.find('button:last-child'),
	          m = picker.find('button:first-child'),
	          input = picker.find('input'),                 
	          min = parseInt(input.attr('min'), 10),
	          max = parseInt(input.attr('max'), 10),
	          inputFunc = function(picker) {
	            var i = parseInt(input.val(), 10);
	            if ( (i <= min) || (!i) ) {
	              input.val(min);
	              p.prop(dis, false);
	              m.prop(dis, true);
	            } else if (i >= max) {
	              input.val(max);
	              p.prop(dis, true); 
	              m.prop(dis, false);
	            } else {
	              p.prop(dis, false);
	              m.prop(dis, false);
	            }
	          },
	          changeFunc = function(picker, qty) {
	            var q = parseInt(qty, 10),
	                i = parseInt(input.val(), 10);
	            if ((i < max && (q > 0)) || (i > min && !(q > 0))) {
	              input.val(i + q);
	              inputFunc(picker);
	            }
	          };
	      m.on('click', function(e){e.preventDefault();changeFunc(picker,-1);update_slots();});
	      p.on('click', function(e){e.preventDefault();changeFunc(picker,1);update_slots();});
	      input.on('change', function(){
	      	inputFunc(picker);
	      	update_slots();
			});
	      inputFunc(picker); //init
	    });
	  };
	}(jQuery));

	// Init
	$('.plusminus').numberPicker();
	
	function update_slots(){
		var slot_container = 0;
	    var slots = new Array();

        //e.preventDefault();
        $( ".slots-container" ).each( function() {
            var inside_slots = new Array();
            var slot_number = 0;
           $( this ).find( '.single-slot-time' ).each( function(slot_time) {
                inside_slots[slot_number] = $( this ).text() + '|' + $( this ).parent().parent().find('#slot-qty').val();
                slot_number++;
           });
           slots[slot_container] = inside_slots;
           slot_container++;
        });
        $( '#_slots' ).val(JSON.stringify(slots));
        console.log(JSON.stringify(slots));
        //$( this ).submit();
    
	}


	// calendar
 // $(".cmb-type-listeo-calendar #listeo-calendar-outer-container").on(
//     "click",
//     "span.calendar-day-date",
//     function (e) {
//       e.preventDefault();
//       var td = $(this).parent();
//       var date = td.data("date");
//       var $el = $(".listeo-calendar-avail");

//       if (!date) return;

//       var current_dates = $el.val() || "";

    //   if (td.hasClass("not_active")) {
    //     td.removeClass("not_active");
    //     current_dates = current_dates.replace(date + "|", "");
    //   } else {
    //     td.addClass("not_active");
    //     current_dates += date + "|";
    //   }

    //   // Cleanup any duplicate separators
    //   current_dates = current_dates.replace(/\|+/g, "|");

    //   $el.val(current_dates);
//     }
//   );
  
  $('.cmb-type-listeo-calendar #listeo-calendar-outer-container').on("click", 'span.calendar-day-date', function(e) { 
     e.preventDefault();
     var td = $(this).parent();
     var date = td.data("date");
     var $el = $(".listeo-calendar-avail");

     if (!date) return;

     var current_dates = $el.val() || "";

     if (td.hasClass("not_active")) {
       td.removeClass("not_active");
       current_dates = current_dates.replace(date + "|", "");
     } else {
       td.addClass("not_active");
       current_dates += date + "|";
     }

     // Cleanup any duplicate separators
     current_dates = current_dates.replace(/\|+/g, "|");

     $el.val(current_dates);
      
      
  });

  $('.cmb-type-listeo-calendar #listeo-calendar-outer-container').on("click", 'button', function(e) { 
    e.preventDefault();
      var td = $(this).parent().parent();
      var timestamp = td.data('timestamp');
      var date = td.data('date');
      var $el = $(".listeo-calendar-avail");
      var current_price = $(this).prev('span').text();
   
      var price = (function ask() {        
        var n = prompt("Set price for this date");
        console.log(typeof n);
        if (n === null) {
         return n;
        } else if ( n === '' ) {
          return current_price;
        }
         else {
          return isNaN(n) ? ask() : n;  
        }
        
      }());
      var json = {};
      if (price != null) {
        $(this).parent().find('span').html(price);
          // json.push({
          //   date : price
          // });
          var current_value = $(".listeo-calendar-price").val();
          if(current_value) {
            var json = jQuery.parseJSON($(".listeo-calendar-price").val());  
          }
          json[date] = price;
          var stringit = JSON.stringify(json);
          $(".listeo-calendar-price").val(stringit);
      }

  });

  $('#_normal_price').on('input', function(e) {
      e.preventDefault();
      var price = $(this).val();
      $('.listeo-calendar-day:not(.weekend) .calendar-price span').html(price);
      submit_calendar_update_price();
  });

  $('#_weekend_price,#_weekday_price').on('input', function(e) {
      e.preventDefault();
      var price = $(this).val();
      $('.listeo-calendar-day.weekend .calendar-price span').html(price);
      submit_calendar_update_price();
  
  });


  $('.cmb-type-listeo-calendar #listeo-calendar-outer-container').on("click", '.prev', function(event) { 
      var month =  $(this).data("prev-month");
      var year =  $(this).data("prev-year");
      getCalendar(month,year);
  });

  $('.cmb-type-listeo-calendar #listeo-calendar-outer-container').on("click", '.next', function(event) { 
  	
      var month =  $(this).data("next-month");
      var year =  $(this).data("next-year");
      getCalendar(month,year);
  });
  $('.cmb-type-listeo-calendar #listeo-calendar-outer-container').on("blur", '#currentYear', function(event) { 
      var month =  $('#currentMonth').text();
      var year = $('#currentYear').text();
      getCalendar(month,year);
  });

  

// Listeo PayOut
let pp_activate_elem = $('#payout_activation');

if ($(pp_activate_elem).length > 0){
	show_hide_paypal_payout_all_inputs();
}

$(pp_activate_elem).change(function (){
	show_hide_paypal_payout_all_inputs();
})

let pp_env_elem = $('#payout_environment');
if ($(pp_env_elem).length > 0){
	if ($(pp_activate_elem).val() === 'yes'){
		show_hide_paypal_payout_api_inputs();
	}
}

$(pp_env_elem).change(function (){
	show_hide_paypal_payout_api_inputs();
})

function show_hide_paypal_payout_all_inputs(){
	if ($(pp_activate_elem).val() === 'no'){
		$('#payout_environment').parents('tr.listeo_settings_select').hide();

		$('#payout_sandbox_client_id').parents('tr.listeo_settings_text').hide();
		$('#payout_sandbox_client_secret').parents('tr.listeo_settings_password').hide();

		$('#payout_live_client_id').parents('tr.listeo_settings_text').hide();
		$('#payout_live_client_secret').parents('tr.listeo_settings_password').hide();

		$('#payout_email_subject').parents('tr.listeo_settings_textarea').hide();
		$('#payout_email_message').parents('tr.listeo_settings_textarea').hide();
		$('#payout_trx_note').parents('tr.listeo_settings_textarea').hide();
	}else{
		$('#payout_environment').parents('tr.listeo_settings_select').show();
		show_hide_paypal_payout_api_inputs();
		$('#payout_email_subject').parents('tr.listeo_settings_textarea').show();
		$('#payout_email_message').parents('tr.listeo_settings_textarea').show();
		$('#payout_trx_note').parents('tr.listeo_settings_textarea').show();
	}
}

function show_hide_paypal_payout_api_inputs(){
	let pp_env_elem = $('#payout_environment');
	let pp_payout_env = $(pp_env_elem).val();

	if (pp_payout_env === 'live'){
		// hide sandboxes inputs
		$('#payout_sandbox_client_id').parents('tr.listeo_settings_text').hide();
		$('#payout_sandbox_client_secret').parents('tr.listeo_settings_password').hide();

		// show live inputs
		$('#payout_live_client_id').parents('tr.listeo_settings_text').show();
		$('#payout_live_client_secret').parents('tr.listeo_settings_password').show();
	}else if (pp_payout_env === 'sandbox'){
		// hide live inputs
		$('#payout_live_client_id').parents('tr.listeo_settings_text').hide();
		$('#payout_live_client_secret').parents('tr.listeo_settings_password').hide();

		// show sandbox inputs
		$('#payout_sandbox_client_id').parents('tr.listeo_settings_text').show();
		$('#payout_sandbox_client_secret').parents('tr.listeo_settings_password').show();
	}
}

$('.cancel-payout-button').click(function (e){
	e.preventDefault();
	e.stopImmediatePropagation();

	if (window.confirm(listeo_admin.pp_cancel_payout_confirmation_msg)) {
		let $this = $(this);

		$this.parents('#listeo-make-payout').find('.loader-div').removeClass('listeo-hidden');

		var data = {
			'action': 'listeo_cancel_payout_request',
			'pp_item_id': $($this).attr('data-pp_item_id'),
			'commission_id': $($this).attr('data-commission_id'),
		};

		jQuery.post(listeo_admin.ajax_url, data, function(response) {
			if (response.data.success === true){
				// refresh the page. So, the admin can see the changes.
				window.location = window.location.href;
			}else{
				alert(response.data.msg);
				$($this).parents('#listeo-make-payout').find('.loader-div').addClass('listeo-hidden');
			}
		});
	}
})

let listeo_payout_check_boxes_td = $('#listeo-make-payout').find('table tbody tr > td:first-child');
let listeo_payout_checkboxes = $(listeo_payout_check_boxes_td).find('input[type=checkbox]');

$(listeo_payout_checkboxes).change(function () {
	let $this = $(this);
	listeo_check_cbs();
});

listeo_check_cbs();
function listeo_check_cbs(){
	let is_any_cb_checked = false;
	$(listeo_payout_check_boxes_td).each(function (i, e) {
		let cb = $(e).find('input[type=checkbox]');
		if ($(cb).is(':checked')){
			is_any_cb_checked = true;
			listeo_remove_payout_class();
		}
	});

	if (! is_any_cb_checked){
		listeo_add_payout_class();
	}
}
function listeo_remove_payout_class(){
	$('#listeo-make-payout').find('input[name="submit_new_payout"]').removeClass('listeo_disable').attr('disabled', false);
}

function listeo_add_payout_class(){
	$('#listeo-make-payout').find('input[name="submit_new_payout"]').addClass('listeo_disable').attr('disabled', true);
}

// Listeo PayOut - Ends

  function getCalendar(month,year){
     $.ajax({
         type   : "post",
         dataType : "json",
         url    : ajaxurl,
         data   : { action: "listeo_core_calendar", month : month, year: year},
         success  : function(data) {
            	$("#listeo-calendar-outer").html(data.response);  
             	var _normal_price = $('#_normal_price').val();
			  	$('.listeo-calendar-day:not(.weekend) .calendar-price span').html(_normal_price);
			  	var _weekend_price = $('#_weekday_price').val();
			   	$('.listeo-calendar-day.weekend .calendar-price span').html(_weekend_price);
	            submit_calendar_update_price();
	            submit_calendar_update_unav_days();
         }
      })   
  }

  function submit_calendar_update_unav_days(){
      var days = $(".listeo-calendar-avail").val();
      if(days){
        var array = days.split("|");
        
        $.each( array, function( key, day ) {
          if( day ) {
            $("td.listeo-calendar-day[data-date='" + day +"']").addClass('not_active');
          }
        });
      }
      
  }

  function submit_calendar_update_price(){
      var prices = $(".listeo-calendar-price").val();
      if(prices){
         var obj = JSON.parse(prices);
      
      $.each( obj, function( day, price ) {
        if( day ) {
          $("td.listeo-calendar-day[data-date='" + day +"'] .calendar-price span").text(price);
        }
      });
      }
     
  }
	  	var _normal_price = $('#_normal_price').val();
	  	$('.listeo-calendar-day:not(.weekend) .calendar-price span').html(_normal_price);
	  	var _weekend_price = $('#_weekday_price').val();
	   	$('.listeo-calendar-day.weekend .calendar-price span').html(_weekend_price);
  		submit_calendar_update_price();
  		submit_calendar_update_unav_days();
	
		var dateformat = wordpress_date_format.date.toLowerCase().replace("yyyy", "yy");
		console.log(dateformat);
        $('.input-datetime').datepicker({
            dateFormat : dateformat,
            onSelect: function(datetext){

		        var d = new Date(); // for now

		        var h = d.getHours();
		        h = (h < 10) ? ("0" + h) : h ;

		        var m = d.getMinutes();
		        m = (m < 10) ? ("0" + m) : m ;

		     

		        datetext = datetext + " " + h + ":" + m

		       $(this).val(datetext);
		    }
        });
    
	/*eof*/

	});
}(jQuery));

